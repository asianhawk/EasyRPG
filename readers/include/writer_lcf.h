/////////////////////////////////////////////////////////////////////////////
// This file is part of EasyRPG.
//
// EasyRPG is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// EasyRPG is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with EasyRPG Player. If not, see <http://www.gnu.org/licenses/>.
/////////////////////////////////////////////////////////////////////////////

#ifndef _EASYRPG_WRITER_H_
#define _EASYRPG_WRITER_H_

////////////////////////////////////////////////////////////
// Headers
////////////////////////////////////////////////////////////
#include <string>
#include <vector>
#include <iosfwd>
#include <cstring>
#include <cstdio>
#include <cassert>
#ifndef _MSC_VER
	#include <stdint.h>
#else
	typedef	unsigned char	uint8_t;
	typedef	signed short	int16_t;
	typedef unsigned short	uint16_t;
	typedef	signed int		int32_t;
	typedef unsigned int	uint32_t;
#endif
#include "reader_options.h"
#include "reader_util.h"

////////////////////////////////////////////////////////////
/// LcfWriter class.
////////////////////////////////////////////////////////////
class LcfWriter {
public:
	////////////////////////////////////////////////////////
	/// Constructs a new File Writer.
	/// @param filename : File to open.
	////////////////////////////////////////////////////////
	LcfWriter(const char* filename, std::string encoding = "");

	////////////////////////////////////////////////////////
	/// Constructs a new File Writer.
	/// @param filename : File to open.
	////////////////////////////////////////////////////////
	LcfWriter(const std::string& filename, std::string encoding = "");

	////////////////////////////////////////////////////////
	/// Destructor. Closes the opened file.
	////////////////////////////////////////////////////////
	~LcfWriter();

	////////////////////////////////////////////////////////
	/// Closes the opened file.
	////////////////////////////////////////////////////////
	void Close();

	////////////////////////////////////////////////////////
	/// Writes raw data to the stream (fwrite() wrapper)
	/// @param ptr : pointer to buffer
	/// @param size : size of each element
	/// @param nmemb : number of elements
	////////////////////////////////////////////////////////
	void Write(const void *ptr, size_t size, size_t nmemb);

	////////////////////////////////////////////////////////
	/// Write a boolean to the stream.
	/// @param val : the value
	////////////////////////////////////////////////////////
	void WriteBool(bool val);

	////////////////////////////////////////////////////////
	/// Write one byte to the stream.
	/// @param val : the 8-bit integer
	////////////////////////////////////////////////////////
	void Write8(uint8_t val);

	////////////////////////////////////////////////////////
	/// Writes two bytes to the stream.
	/// @param val : The 16-bit integer
	////////////////////////////////////////////////////////
	void Write16(int16_t val);

	////////////////////////////////////////////////////////
	/// Writes four bytes to the stream.
	/// @param val : The 32-bit integer
	////////////////////////////////////////////////////////
	void Write32(int32_t val);

	////////////////////////////////////////////////////////
	/// Writes a compressed integer to the stream.
	/// @param val : The integer
	////////////////////////////////////////////////////////
	void WriteInt(int32_t val);

	////////////////////////////////////////////////////////
	/// Writes a "double" to the stream
	/// @param val : The double
	////////////////////////////////////////////////////////
	void WriteDouble(double val);

	////////////////////////////////////////////////////////
	/// Writes booleans.
	/// @param buffer : Vector to write
	////////////////////////////////////////////////////////
	void WriteBool(const std::vector<bool>& buffer);

	////////////////////////////////////////////////////////
	/// Writes single bytes.
	/// @param buffer : Vector to write
	////////////////////////////////////////////////////////
	void Write8(const std::vector<uint8_t>& buffer);

	////////////////////////////////////////////////////////
	/// Writes 16-bit integers.
	/// @param buffer : Vector to write
	////////////////////////////////////////////////////////
	void Write16(const std::vector<int16_t>& buffer);

	////////////////////////////////////////////////////////
	/// Writes 32-bit integers (not compressed)
	/// @param buffer : Vector to write
	////////////////////////////////////////////////////////
	void Write32(const std::vector<uint32_t>& buffer);

	////////////////////////////////////////////////////////
	/// Writes a string.
	/// @param str : String
	/// Note: The string is converted from UTF-8
	////////////////////////////////////////////////////////
	void WriteString(const std::string& str);

	////////////////////////////////////////////////////////
	/// Checks if the file is writable and if no error
	/// occured.
	/// @return If the stream is okay
	////////////////////////////////////////////////////////
	bool IsOk() const;

	////////////////////////////////////////////////////////
	/// Decodes a string from Utf8 to the set encoding
	/// in the Writer constructor.
	/// @param str_to_encode : UTF-8 string to encode
	/// @return native version of string
	////////////////////////////////////////////////////////
	std::string Decode(const std::string& str_to_encode);

private:
	/// Name of the file that is associated with the stream
	std::string filename;
	/// Name of the encoding
	std::string encoding;
	/// File-stream managed by this Writer
	FILE* stream;

#ifdef READER_BIG_ENDIAN
	////////////////////////////////////////////////////////
	/// Utility function for Big Endian Systems.
	/// Convert a 16bit integer from little to big endian.
	/// @param us : Integer to convert
	////////////////////////////////////////////////////////
	static void SwapByteOrder(uint16_t &us);

	////////////////////////////////////////////////////////
	/// Utility function for Big Endian Systems.
	/// Convert a 32bit integer from little to big endian.
	/// @param us : Integer to convert
	////////////////////////////////////////////////////////
	static void SwapByteOrder(uint32_t &ui);
#endif
};

#endif
